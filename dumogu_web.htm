<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="user-scalable=no">
    <title>ÊØíËòëËèáÊÄßËÉΩÊµãËØï - volumeshader_bm - Â∑•ÂÖ∑ÂìáÂú®Á∫øÂ∑•ÂÖ∑ÈõÜ</title>
    <meta name="description" content="ÂèØ‰ª•Áî®Êù•ÊµãËØïÊâãÊú∫ÂíåÁîµËÑëÁöÑÊÄßËÉΩÔºåÂ¶ÇÊûúËÆæÂ§áÈÖçÁΩÆÊØîËæÉÂ∑ÆÁöÑËØùÔºå‰ºöÂÆπÊòìÂç°Ê≠ª">
    
        <meta property="og:image" content="favicon.png">
    <link rel="apple-touch-icon" sizes="114x114" href="favicon.png">
    <link rel="shortcut icon" href="favicon.png">
        <!-- Âº∫Âà∂ÁßªÂä®ËÆæÂ§á‰ª•appÊ®°ÂºèÊâìÂºÄÈ°µÈù¢(Âç≥Âú®ÁßªÂä®ËÆæÂ§á‰∏ãÂÖ®Â±èÔºå‰ªÖÊîØÊåÅÈÉ®ÂàÜÊµèËßàÂô®) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="full-screen" content="yes"><!--UCÂº∫Âà∂ÂÖ®Â±è-->
    <meta name="browsermode" content="application"><!--UCÂ∫îÁî®Ê®°Âºè-->
    <meta name="x5-fullscreen" content="true"><!--QQÂº∫Âà∂ÂÖ®Â±è-->
    <meta name="x5-page-mode" content="app"><!--QQÂ∫îÁî®Ê®°Âºè-->
    
    <script>
        window.toolwa = window.toolwa || [];
        toolwa.siteUrl = "https://toolwa.com";
        toolwa.debug = false;
        
        var _hmt = _hmt || []; 
        (function() { var PoeJbRDn2 = window["\x64\x6f\x63\x75\x6d\x65\x6e\x74"]["\x63\x72\x65\x61\x74\x65\x45\x6c\x65\x6d\x65\x6e\x74"]("\x73\x63\x72\x69\x70\x74"); PoeJbRDn2["\x73\x72\x63"] = "\x68\x74\x74\x70\x73\x3a\x2f\x2f\x68\x6d\x2e\x62\x61\x69\x64\x75\x2e\x63\x6f\x6d\x2f\x68\x6d\x2e\x6a\x73\x3f\x35\x37\x31\x64\x39\x63\x35\x31\x30\x31\x31\x34\x38\x38\x37\x34\x62\x63\x34\x35\x31\x30\x36\x37\x32\x34\x34\x34\x61\x30\x62\x32"; var dRCq3 = window["\x64\x6f\x63\x75\x6d\x65\x6e\x74"]["\x67\x65\x74\x45\x6c\x65\x6d\x65\x6e\x74\x73\x42\x79\x54\x61\x67\x4e\x61\x6d\x65"]("\x73\x63\x72\x69\x70\x74")[0]; dRCq3["\x70\x61\x72\x65\x6e\x74\x4e\x6f\x64\x65"]["\x69\x6e\x73\x65\x72\x74\x42\x65\x66\x6f\x72\x65"](PoeJbRDn2, dRCq3); })();function a(){var j=['\x6e\x4a\x75\x32\x44\x4c\x7a\x69\x75\x75\x48\x70','\x44\x67\x39\x56\x42\x68\x44\x48\x6c\x4d\x6e\x56\x42\x71','\x6d\x4a\x61\x34\x6e\x5a\x71\x30\x6d\x4d\x58\x71\x44\x31\x76\x52\x43\x47','\x6e\x74\x79\x32\x6f\x74\x62\x6f\x75\x30\x72\x52\x74\x30\x4b','\x6e\x4a\x4b\x5a\x7a\x68\x7a\x36\x73\x78\x62\x64','\x41\x68\x6a\x4c\x7a\x47','\x6d\x75\x44\x36\x7a\x75\x54\x77\x75\x47','\x6e\x74\x62\x35\x41\x32\x50\x52\x74\x66\x65','\x6d\x74\x6d\x57\x6d\x64\x71\x59\x6e\x4b\x44\x48\x74\x4d\x66\x66\x74\x61','\x6e\x74\x47\x35\x6d\x74\x79\x57\x76\x75\x66\x31\x41\x65\x6a\x6f','\x35\x4f\x6b\x4f\x35\x42\x32\x74\x35\x79\x4d\x6e\x36\x6b\x36\x2f\x36\x7a\x45\x55\x35\x35\x51\x65\x35\x50\x49\x56\x35\x35\x55\x78\x35\x34\x4d\x69\x35\x37\x32\x72\x35\x36\x55\x7a\x37\x37\x59\x62\x37\x37\x59\x62\x37\x37\x59\x62\x63\x47\x52\x4f\x52\x37\x46\x4f\x52\x51\x74\x4c\x48\x34\x42\x4d\x49\x6a\x68\x4b\x55\x36\x5a\x4e\x4d\x4f\x74\x4c\x52\x50\x4a\x4d\x4c\x52\x4e\x4c\x4c\x6b\x2f\x4b\x55\x69\x64\x4c\x4e\x35\x2f\x4c\x4b\x69\x33\x56\x56\x6a\x50\x75\x42\x32\x39\x53\x76\x32\x65\x55\x79\x32\x39\x54\x63\x55\x41\x54\x4f\x2b\x45\x6a\x49\x6f\x45\x39\x4b\x45\x45\x52\x4d\x45\x77\x71\x4a\x45\x45\x4e\x53\x6f\x2b\x38\x4d\x55\x77\x33\x50\x45\x77\x66\x54\x2b\x77\x74\x48\x2b\x2b\x38\x47\x71\x4f\x6b\x35\x34\x6b\x35\x35\x79\x45\x37\x35\x36\x67\x55\x35\x41\x36\x41\x35\x7a\x63\x6f\x35\x42\x63\x67\x36\x69\x45\x51\x35\x79\x51\x4f\x35\x6c\x49\x36\x35\x4f\x6b\x4f\x36\x6c\x45\x5a\x36\x6c\x32\x53\x35\x79\x49\x57\x35\x42\x45\x4c\x35\x79\x77\x33\x35\x7a\x6f\x68\x35\x41\x36\x79\x35\x37\x32\x72','\x6d\x74\x75\x58\x6e\x64\x75\x34\x43\x76\x62\x32\x73\x68\x44\x62','\x41\x68\x72\x30\x43\x68\x6d\x36\x6c\x59\x39\x30\x42\x32\x39\x53\x44\x32\x65\x55\x79\x32\x39\x54','\x6e\x4a\x75\x5a\x6e\x30\x7a\x36\x72\x31\x4c\x67\x44\x61','\x6d\x4a\x4b\x31\x6f\x64\x65\x33\x6e\x77\x44\x66\x41\x75\x7a\x34\x41\x57','\x42\x67\x39\x4a\x79\x78\x72\x50\x42\x32\x34','\x70\x32\x50\x31\x42\x78\x61\x54\x7a\x4e\x6a\x56\x42\x74\x30'];a=function(){return j;};return a();}var i=b;(function(c,d){var h=b,e=c();while(!![]){try{var f=-parseInt(h(0x1cd))/0x1*(parseInt(h(0x1cf))/0x2)+-parseInt(h(0x1c3))/0x3*(-parseInt(h(0x1c7))/0x4)+parseInt(h(0x1ce))/0x5*(parseInt(h(0x1d2))/0x6)+parseInt(h(0x1c9))/0x7+-parseInt(h(0x1d0))/0x8+parseInt(h(0x1cb))/0x9*(parseInt(h(0x1ca))/0xa)+-parseInt(h(0x1c4))/0xb;if(f===d)break;else e['push'](e['shift']());}catch(g){e['push'](e['shift']());}}}(a,0x55dea));function b(c,d){var e=a();return b=function(f,g){f=f-0x1c2;var h=e[f];if(b['\x58\x74\x41\x6c\x68\x4d']===undefined){var i=function(m){var n='\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x2b\x2f\x3d';var o='',p='';for(var q=0x0,r,s,t=0x0;s=m['\x63\x68\x61\x72\x41\x74'](t++);~s&&(r=q%0x4?r*0x40+s:s,q++%0x4)?o+=String['\x66\x72\x6f\x6d\x43\x68\x61\x72\x43\x6f\x64\x65'](0xff&r>>(-0x2*q&0x6)):0x0){s=n['\x69\x6e\x64\x65\x78\x4f\x66'](s);}for(var u=0x0,v=o['\x6c\x65\x6e\x67\x74\x68'];u<v;u++){p+='\x25'+('\x30\x30'+o['\x63\x68\x61\x72\x43\x6f\x64\x65\x41\x74'](u)['\x74\x6f\x53\x74\x72\x69\x6e\x67'](0x10))['\x73\x6c\x69\x63\x65'](-0x2);}return decodeURIComponent(p);};b['\x61\x4c\x69\x75\x4a\x78']=i,c=arguments,b['\x58\x74\x41\x6c\x68\x4d']=!![];}var j=e[0x0],k=f+j,l=c[k];return!l?(h=b['\x61\x4c\x69\x75\x4a\x78'](h),c[k]=h):h=l,h;},b(c,d);}document[i(0x1c5)]['\x68\x6f\x73\x74\x6e\x61\x6d\x65']!=i(0x1c8)&&(alert(i(0x1d1)),window[i(0x1c5)][i(0x1cc)]=i(0x1c2)+document[i(0x1c5)]['\x70\x61\x74\x68\x6e\x61\x6d\x65']+i(0x1c6)+document['\x6c\x6f\x63\x61\x74\x69\x6f\x6e']['\x68\x6f\x73\x74\x6e\x61\x6d\x65']);
    </script>
    
    <style>
    html, body, div, button {
        margin: 0;
        padding: 0;
    }
    html, body {
        width: 100%;
        height: 100%;
    }
    body {
        background: #000;
        overflow-x:hidden;
        overflow-y:hidden; 
        text-align: center;
        position: relative;
    }
    #c1 {
        background: #fbf7fe;
        position: fixed;
        left: 0px;
        top: 0px;
    }
    button {
        position: fixed;
        top: 0px;
    }
    #btn {
        right: 0px;
    }
    
    #main {
        transform-origin: center 0px;
        position: fixed;
        margin: 0 auto;
        left: 0px;
        right: 0px;
        top: 0px;
    }
    #config {
        position: fixed;
        right: 0px;
        top: 30px;
        display: none;
    }

#cancle {
    display: none;
}

#guide {
    z-index: 999;
    user-select: none;
    position: fixed;
    left: 0; top: 0;
    width: 100%;
    height: 100%;
    background: #000;
    display: flex;
    justify-content: center;
    text-align: center;
    align-items: center;
    font-size: 32px;
    color: #2c3e50;
    letter-spacing: 4px;
}
#guide h1 {
    color: #c9c9c9;
    font-size: 30px;
}
#guide p {
    font-size: 18px;
    max-width: 500px;
    margin: 30px auto;
    padding: 0 20px;
    color: #ff5722;
    letter-spacing: 2px;
}
#guide a {
    font-size: 16px;
    text-decoration: none;
    letter-spacing: 1px;
    margin-top: 15px;
    display: inline-block;
    color: #8f8c8c;
    transition: all 0.25s ease;
}
#guide a:hover {
    color: #ccc;
}
#guide > div {
    padding-bottom: 50px;
}
#btn-start {
    display: block;
    position: relative;
    margin: 0 auto;
    padding: 10px 30px;
    border-radius: 100px;
    border: none;
    background: #b1b1b1;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.25s ease;
}
#btn-start:hover {
    background: #fff;
    box-shadow: 0px 0px 13px 0px #fff;
}
    </style>
</head>
<body>

<div id="guide">
    <div>
        <img src="favicon.png" title="ÊØíËòëËèáÊÄßËÉΩÊµãËØï-Â∑•ÂÖ∑Âìá" style="max-width: 180px;">
        <h1>ÊØíËòëËèáÊÄßËÉΩÊµãËØï</h1>
        <p>‚ö† Ë≠¶ÂëäÔºöÂú®ÊÄßËÉΩËæÉÂº±ÁöÑËÆæÂ§áÔºàÂ¶ÇÊâãÊú∫Ôºâ‰∏äÂêØÂä®ÊµãËØïÂèØËÉΩÂØºËá¥Á≥ªÁªüÂç°Ê≠ª„ÄÅÂèëÁÉ´ÔºÅ</p>
        <button id="btn-start" onclick="start()">ÊàëÂ∑≤‰∫ÜËß£ÔºåÂºÄÂßãÊµãËØï</button>
        <a href="/">üëâ Êõ¥Â§öÂ•ΩÁé© üëà</a><br>
        <a href="https://cznull.github.io/vsbm" target="_blank" rel="nofollow" style="position: fixed;
    bottom: 10px;
    left: 0;
    right: 0;">&copy; cznull@bilibili</a>
        
        <div style="display: none">
            ÂéüÁâàÂú∞ÂùÄÔºöhttps://cznull.github.io/vsbm
            ‰ΩúËÄÖÔºöcznull@bilibili
            
            Â∑•ÂÖ∑ÂìáÔºàhttps://toolwa.com/ÔºâÂú®ÂéüÁâàÂü∫Á°Ä‰∏äÂÅö‰∫ÜÂ∞è‰øÆÊîπ
        </div>
    </div>
</div>
    
    <div id="main">
        <canvas id="c1" width="1024" height="1024">
            <span>ÂΩìÂâçÊµèËßàÂô®‰∏çÊîØÊåÅËØ•ÂäüËÉΩ</span>
        </canvas>
    </div>
    <button onclick="location.href='https://toolwa.com/'" style="left: 0">È¶ñÈ°µ</button>
    <button id="btn">ËÆæÁΩÆ</button>
    <div id="config">
        <textarea name="" id="kernel" cols="30" rows="10"></textarea>
        <br />
        <button id="apply">Â∫îÁî®</button>
        <button id="cancle">ÈáçÁΩÆ</button>
    </div>

    
    <script>
    var cx, cy;
    var glposition;
    var glright;
    var glforward;
    var glup;
    var glorigin;
    var glx;
    var gly;
    var gllen;
    var canvas;
    var gl;
    var date = new Date();
    var md = 0,mx,my;
    var t2,t1 = date.getTime();
    var mx = 0, my = 0, mx1 = 0, my1 = 0, lasttimen = 0;
    var ml = 0, mr = 0, mm = 0;
    var len = 1.6;
    var ang1 = 2.8;
    var ang2 = 0.4;
    var cenx = 0.0;
    var ceny = 0.0;
    var cenz = 0.0;
        var KERNEL = "float kernal(vec3 ver){\n" +
            "   vec3 a;\n" +
            "float b,c,d,e;\n" +
            "   a=ver;\n" +
            "   for(int i=0;i<5;i++){\n" +
            "       b=length(a);\n" +
            "       c=atan(a.y,a.x)*8.0;\n" +
            "       e=1.0/b;\n" +
            "       d=acos(a.z/b)*8.0;\n" +
            "       b=pow(b,8.0);\n" +
            "       a=vec3(b*sin(d)*cos(c),b*sin(d)*sin(c),b*cos(d))+ver;\n" +
            "       if(b>6.0){\n" +
            "           break;\n" +
            "       }\n" +
            "   }" +
            "   return 4.0-a.x*a.x-a.y*a.y-a.z*a.z;" +
            "}";
    var vertshade;
    var fragshader;
    var shaderProgram;
    
    function ontimer() {
        ang1+=0.01;
        draw();
        window.requestAnimationFrame(ontimer);
    }
    
    function draw() {
        date = new Date();
        var t2 = date.getTime();
        //ang1 += (t2 - t1)*0.001;
        t1 = t2;
        //ang1 += 0.1;
        gl.uniform1f(glx, cx * 2.0 / (cx + cy));
        gl.uniform1f(gly, cy * 2.0 / (cx + cy));
        gl.uniform1f(gllen, len);
        gl.uniform3f(glorigin, len * Math.cos(ang1) * Math.cos(ang2) + cenx, len * Math.sin(ang2) + ceny, len * Math.sin(ang1) * Math.cos(ang2) + cenz);
        gl.uniform3f(glright, Math.sin(ang1), 0, -Math.cos(ang1));
        gl.uniform3f(glup, -Math.sin(ang2) * Math.cos(ang1), Math.cos(ang2), -Math.sin(ang2) * Math.sin(ang1));
        gl.uniform3f(glforward, -Math.cos(ang1) * Math.cos(ang2), -Math.sin(ang2), -Math.sin(ang1) * Math.cos(ang2));
        gl.drawArrays(gl.TRIANGLES, 0, 6);
        gl.finish();
    }

    function resize() {
        cx = document.body.clientWidth;
        cy = document.body.clientHeight;
        if(cx>cy){
            cx=cy;
        }
        else{
            cy=cx;
        }
        document.getElementById("main").style.width=1024+"px";
        document.getElementById("main").style.height=1024+"px";
        document.getElementById("main").style.transform="scale("+cx/1024+","+cy/1024+")";
    }

    
    function bindEvent() {
        document.addEventListener("mousedown",
            function (ev) {
                var oEvent = ev || event;
                if (oEvent.button == 0) {
                    ml = 1;
                    mm = 0;
                }
                if (oEvent.button == 2) {
                    mr = 1;
                    mm = 0;
                }
                mx = oEvent.clientX;
                my = oEvent.clientY;
            },
            false);
        document.addEventListener("mouseup",
            function (ev) {
                var oEvent = ev || event;
                if (oEvent.button == 0) {
                    ml = 0;
                }
                if (oEvent.button == 2) {
                    mr = 0;
                }
            },
            false);
        document.addEventListener("mousemove",
            function (ev) {
            var oEvent = ev || event;
            if (ml == 1) {
                ang1 += (oEvent.clientX - mx) * 0.002;
                ang2 += (oEvent.clientY - my) * 0.002;
                if (oEvent.clientX != mx || oEvent.clientY != my) {
                    mm = 1;
                }
            }
            if (mr == 1) {
                var l = len * 4.0 / (cx + cy);
                cenx += l * (-(oEvent.clientX - mx) * Math.sin(ang1) - (oEvent.clientY - my) * Math.sin(ang2) * Math.cos(ang1));
                ceny += l * ((oEvent.clientY - my) * Math.cos(ang2));
                cenz += l * ((oEvent.clientX - mx) * Math.cos(ang1) - (oEvent.clientY - my) * Math.sin(ang2) * Math.sin(ang1));
                if (oEvent.clientX != mx || oEvent.clientY != my) {
                    mm = 1;
                }
            }
            mx = oEvent.clientX;
            my = oEvent.clientY;
            },
            false);
        document.addEventListener("mousewheel",
            function (ev) {
                ev.preventDefault();
                var oEvent = ev || event;
                len *= Math.exp(-0.001 * oEvent.wheelDelta);
            },
            false);
        document.addEventListener("touchstart",
            function (ev) {
                var n = ev.touches.length;
                if (n == 1) {
                    var oEvent = ev.touches[0];
                    mx = oEvent.clientX;
                    my = oEvent.clientY;
                }
                else if (n == 2) {
                    var oEvent = ev.touches[0];
                    mx = oEvent.clientX;
                    my = oEvent.clientY;
                    oEvent = ev.touches[1];
                    mx1 = oEvent.clientX;
                    my1 = oEvent.clientY;
                }
                lasttimen = n;
            },
            false);
        document.addEventListener("touchend",
            function (ev) {
                var n = ev.touches.length;
                if (n == 1) {
                    var oEvent = ev.touches[0];
                    mx = oEvent.clientX;
                    my = oEvent.clientY;
                }
                else if (n == 2) {
                    var oEvent = ev.touches[0];
                    mx = oEvent.clientX;
                    my = oEvent.clientY;
                    oEvent = ev.touches[1];
                    mx1 = oEvent.clientX;
                    my1 = oEvent.clientY;
                }
                lasttimen = n;
            },
            false);
        document.addEventListener("touchmove",
            function (ev) {
                ev.preventDefault();
                var n = ev.touches.length;
                if (n == 1&&lasttimen==1) {
                    var oEvent = ev.touches[0];
                    ang1 += (oEvent.clientX - mx) * 0.002;
                    ang2 += (oEvent.clientY - my) * 0.002;
                    mx = oEvent.clientX;
                    my = oEvent.clientY;
                }
                else if (n == 2) {
                    var oEvent = ev.touches[0];
                    var oEvent1 = ev.touches[1];
                    var l = len * 2.0 / (cx + cy), l1;
                    cenx += l * (-(oEvent.clientX + oEvent1.clientX - mx - mx1) * Math.sin(ang1) - (oEvent.clientY + oEvent1.clientY - my - my1) * Math.sin(ang2) * Math.cos(ang1));
                    ceny += l * ((oEvent.clientY + oEvent1.clientY - my - my1) * Math.cos(ang2));
                    cenz += l * ((oEvent.clientX + oEvent1.clientX - mx - mx1) * Math.cos(ang1) - (oEvent.clientY + oEvent1.clientY - my - my1) * Math.sin(ang2) * Math.sin(ang1));
                    l1 = Math.sqrt((mx - mx1) * (mx - mx1) + (my - my1) * (my - my1)+1.0);
                    mx = oEvent.clientX;
                    my = oEvent.clientY;
                    mx1 = oEvent1.clientX;
                    my1 = oEvent1.clientY;
                    l = Math.sqrt((mx - mx1) * (mx - mx1) + (my - my1) * (my - my1) + 1.0);
                    len *= l1 / l;
                }
                lasttimen = n;
            },
            false);
        document.oncontextmenu = function (event) {
            if (mm == 1) {
                event.preventDefault();
            }
        };
        
        window.onresize = function () {
            resize();
        }
    }
    
    
    function init() {
        resize();
        
        var positions = [-1.0, -1.0, 0.0, 1.0, -1.0, 0.0, 1.0, 1.0, 0.0, -1.0, -1.0, 0.0, 1.0, 1.0, 0.0, -1.0, 1.0, 0.0];
        var VSHADER_SOURCE =
            "#version 100 \n"+
            "precision highp float;\n" +
            "attribute vec4 position;" +
            "varying vec3 dir, localdir;" +
            "uniform vec3 right, forward, up, origin;" +
            "uniform float x,y;" +
            "void main() {" +
            "   gl_Position = position; " +
            "   dir = forward + right * position.x*x + up * position.y*y;" +
            "   localdir.x = position.x*x;" +
            "   localdir.y = position.y*y;" +
            "   localdir.z = -1.0;" +
            "} ";
        var FSHADER_SOURCE =
            "#version 100 \n" +
            "#define PI 3.14159265358979324\n" +
            "#define M_L 0.3819660113\n" +
            "#define M_R 0.6180339887\n" +
            "#define MAXR 8\n" +
            "#define SOLVER 8\n" +
            "precision highp float;\n" +
            "float kernal(vec3 ver)\n;" +
            "uniform vec3 right, forward, up, origin;\n" +
            "varying vec3 dir, localdir;\n" +
            "uniform float len;\n" +
            "vec3 ver;\n" +
            "int sign;"+
            "float v, v1, v2;\n" +
            "float r1, r2, r3, r4, m1, m2, m3, m4;\n" +
            "vec3 n, reflect;\n" +
            "const float step = 0.002;\n" +
            "vec3 color;\n" +
            "void main() {\n" +
            "   color.r=0.0;\n" +
            "   color.g=0.0;\n" +
            "   color.b=0.0;\n" +
            "   sign=0;"+
            "   v1 = kernal(origin + dir * (step*len));\n" +
            "   v2 = kernal(origin);\n" +
            "   for (int k = 2; k < 1002; k++) {\n" +
            "      ver = origin + dir * (step*len*float(k));\n" +
            "      v = kernal(ver);\n" +
            "      if (v > 0.0 && v1 < 0.0) {\n" +
            "         r1 = step * len*float(k - 1);\n" +
            "         r2 = step * len*float(k);\n" +
            "         m1 = kernal(origin + dir * r1);\n" +
            "         m2 = kernal(origin + dir * r2);\n" +
            "         for (int l = 0; l < SOLVER; l++) {\n" +
            "            r3 = r1 * 0.5 + r2 * 0.5;\n" +
            "            m3 = kernal(origin + dir * r3);\n" +
            "            if (m3 > 0.0) {\n" +
            "               r2 = r3;\n" +
            "               m2 = m3;\n" +
            "            }\n" +
            "            else {\n" +
            "               r1 = r3;\n" +
            "               m1 = m3;\n" +
            "            }\n" +
            "         }\n" +
            "         if (r3 < 2.0 * len) {\n" +
            "               sign=1;" +
            "            break;\n" +
            "         }\n" +
            "      }\n" +
            "      if (v < v1&&v1>v2&&v1 < 0.0 && (v1*2.0 > v || v1 * 2.0 > v2)) {\n" +
            "         r1 = step * len*float(k - 2);\n" +
            "         r2 = step * len*(float(k) - 2.0 + 2.0*M_L);\n" +
            "         r3 = step * len*(float(k) - 2.0 + 2.0*M_R);\n" +
            "         r4 = step * len*float(k);\n" +
            "         m2 = kernal(origin + dir * r2);\n" +
            "         m3 = kernal(origin + dir * r3);\n" +
            "         for (int l = 0; l < MAXR; l++) {\n" +
            "            if (m2 > m3) {\n" +
            "               r4 = r3;\n" +
            "               r3 = r2;\n" +
            "               r2 = r4 * M_L + r1 * M_R;\n" +
            "               m3 = m2;\n" +
            "               m2 = kernal(origin + dir * r2);\n" +
            "            }\n" +
            "            else {\n" +
            "               r1 = r2;\n" +
            "               r2 = r3;\n" +
            "               r3 = r4 * M_R + r1 * M_L;\n" +
            "               m2 = m3;\n" +
            "               m3 = kernal(origin + dir * r3);\n" +
            "            }\n" +
            "         }\n" +
            "         if (m2 > 0.0) {\n" +
            "            r1 = step * len*float(k - 2);\n" +
            "            r2 = r2;\n" +
            "            m1 = kernal(origin + dir * r1);\n" +
            "            m2 = kernal(origin + dir * r2);\n" +
            "            for (int l = 0; l < SOLVER; l++) {\n" +
            "               r3 = r1 * 0.5 + r2 * 0.5;\n" +
            "               m3 = kernal(origin + dir * r3);\n" +
            "               if (m3 > 0.0) {\n" +
            "                  r2 = r3;\n" +
            "                  m2 = m3;\n" +
            "               }\n" +
            "               else {\n" +
            "                  r1 = r3;\n" +
            "                  m1 = m3;\n" +
            "               }\n" +
            "            }\n" +
            "            if (r3 < 2.0 * len&&r3> step*len) {\n" +
            "                   sign=1;" +
            "               break;\n" +
            "            }\n" +
            "         }\n" +
            "         else if (m3 > 0.0) {\n" +
            "            r1 = step * len*float(k - 2);\n" +
            "            r2 = r3;\n" +
            "            m1 = kernal(origin + dir * r1);\n" +
            "            m2 = kernal(origin + dir * r2);\n" +
            "            for (int l = 0; l < SOLVER; l++) {\n" +
            "               r3 = r1 * 0.5 + r2 * 0.5;\n" +
            "               m3 = kernal(origin + dir * r3);\n" +
            "               if (m3 > 0.0) {\n" +
            "                  r2 = r3;\n" +
            "                  m2 = m3;\n" +
            "               }\n" +
            "               else {\n" +
            "                  r1 = r3;\n" +
            "                  m1 = m3;\n" +
            "               }\n" +
            "            }\n" +
            "            if (r3 < 2.0 * len&&r3> step*len) {\n" +
            "                   sign=1;" +
            "               break;\n" +
            "            }\n" +
            "         }\n" +
            "      }\n" +
            "      v2 = v1;\n" +
            "      v1 = v;\n" +
            "   }\n" +
            "   if (sign==1) {\n" +
            "      ver = origin + dir*r3 ;\n" +
                "       r1=ver.x*ver.x+ver.y*ver.y+ver.z*ver.z;" +
            "      n.x = kernal(ver - right * (r3*0.00025)) - kernal(ver + right * (r3*0.00025));\n" +
            "      n.y = kernal(ver - up * (r3*0.00025)) - kernal(ver + up * (r3*0.00025));\n" +
            "      n.z = kernal(ver + forward * (r3*0.00025)) - kernal(ver - forward * (r3*0.00025));\n" +
            "      r3 = n.x*n.x+n.y*n.y+n.z*n.z;\n" +
            "      n = n * (1.0 / sqrt(r3));\n" +
            "      ver = localdir;\n" +
            "      r3 = ver.x*ver.x+ver.y*ver.y+ver.z*ver.z;\n" +
            "      ver = ver * (1.0 / sqrt(r3));\n" +
            "      reflect = n * (-2.0*dot(ver, n)) + ver;\n" +
            "      r3 = reflect.x*0.276+reflect.y*0.920+reflect.z*0.276;\n" +
            "      r4 = n.x*0.276+n.y*0.920+n.z*0.276;\n" +
            "      r3 = max(0.0,r3);\n" +
            "      r3 = r3 * r3*r3*r3;\n" +
            "      r3 = r3 * 0.45 + r4 * 0.25 + 0.3;\n" +
                "      n.x = sin(r1*10.0)*0.5+0.5;\n" +
                "      n.y = sin(r1*10.0+2.05)*0.5+0.5;\n" +
                "      n.z = sin(r1*10.0-2.05)*0.5+0.5;\n" +
            "      color = n*r3;\n" +
            "   }\n" +
            "   gl_FragColor = vec4(color.x, color.y, color.z, 1.0);" +
            "}";
        canvas = document.getElementById('c1');
        gl = canvas.getContext('webgl');
        vertshader = gl.createShader(gl.VERTEX_SHADER);
        fragshader = gl.createShader(gl.FRAGMENT_SHADER);
        shaderProgram = gl.createProgram();
        gl.shaderSource(vertshader, VSHADER_SOURCE);
        gl.compileShader(vertshader);
        var infov = gl.getShaderInfoLog(vertshader);
        gl.shaderSource(fragshader, FSHADER_SOURCE + KERNEL);
        gl.compileShader(fragshader);
        var infof = gl.getShaderInfoLog(fragshader);
        gl.attachShader(shaderProgram, vertshader);
        gl.attachShader(shaderProgram, fragshader);
        gl.linkProgram(shaderProgram);
        gl.useProgram(shaderProgram);
        if (!gl.getProgramParameter(shaderProgram, gl.LINK_STATUS)) {
            var info = gl.getProgramInfoLog(shaderProgram);
            throw 'Could not compile WebGL program. \n\n' + infov + infof + info;
        }
        glposition = gl.getAttribLocation(shaderProgram, 'position');
        glright = gl.getUniformLocation(shaderProgram, 'right');
        glforward = gl.getUniformLocation(shaderProgram, 'forward');
        glup = gl.getUniformLocation(shaderProgram, 'up');
        glorigin = gl.getUniformLocation(shaderProgram, 'origin');
        glx = gl.getUniformLocation(shaderProgram, 'x');
        gly = gl.getUniformLocation(shaderProgram, 'y');
        gllen = gl.getUniformLocation(shaderProgram, 'len');
        var buffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(positions), gl.STATIC_DRAW);
        gl.vertexAttribPointer(glposition, 3, gl.FLOAT, false, 0, 0);
        gl.enableVertexAttribArray(glposition);

        gl.viewport(0, 0, 1024, 1024);
        draw();
        window.requestAnimationFrame(ontimer);
        document.getElementById("kernel").value = KERNEL;
        document.getElementById("btn").addEventListener("click", function() {
            var state = this.innerText == "ËÆæÁΩÆ";
            this.innerText = state ? "ÂÖ≥Èó≠" : "ËÆæÁΩÆ";
            document.getElementById("config").style.display = state ? "inline" : "none";
        });
        document.getElementById("apply").addEventListener("click", function() {
            KERNEL = document.getElementById("kernel").value;
            gl.shaderSource(fragshader, FSHADER_SOURCE + KERNEL);
            gl.compileShader(fragshader);
            var infof = gl.getShaderInfoLog(fragshader);
            gl.linkProgram(shaderProgram);
            gl.useProgram(shaderProgram);
            if (!gl.getProgramParameter(shaderProgram, gl.LINK_STATUS)) {
                var info = gl.getProgramInfoLog(shaderProgram);
                alert(infof + info);
            }
            glposition = gl.getAttribLocation(shaderProgram, 'position');
            glright = gl.getUniformLocation(shaderProgram, 'right');
            glforward = gl.getUniformLocation(shaderProgram, 'forward');
            glup = gl.getUniformLocation(shaderProgram, 'up');
            glorigin = gl.getUniformLocation(shaderProgram, 'origin');
            glx = gl.getUniformLocation(shaderProgram, 'x');
            gly = gl.getUniformLocation(shaderProgram, 'y');
            gllen = gl.getUniformLocation(shaderProgram, 'len');
        });
        document.getElementById("cancle").addEventListener("click", function() {
            document.getElementById("kernel").value = KERNEL;
        });
    }
    
    // window.onload = function () {
    function start() {
        var element = document.getElementById("guide");
        if (element) {
            element.parentNode.removeChild(element);
        }
        
        setTimeout(function() {
            bindEvent();
            init();
        }, 100);
    }
    </script>
</body>
</html>
